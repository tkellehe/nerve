<script>
logger_output = "";
function logger(s) {
    let textarea_debug = document.getElementById("debug");
    logger_output += s + "\n";
    textarea_debug.value = logger_output;
}
is_running = false;
async function execute() {
    try {
        if(is_running) throw Error("Still Running...");
        let textarea_header = document.getElementById("header");
        let textarea_code = document.getElementById("code");
        let textarea_footer = document.getElementById("footer");
        let textarea_output = document.getElementById("output");
        let textarea_expression = document.getElementById("expression");
        let a_message = document.getElementById("message");
        a_message.value = "running...";
        is_running = true;
        let code = textarea_header.value + textarea_code.value + textarea_footer.value;
        
        (async () => {
            try {
                global_network_memory_reset();
                let compiled = eval("(function() { return " + code + "})()");
                let result = await compiled.finalize();
                let network = result.network;

                if(result.is_learning) {
                    a_message.value =  "(" + result.num_passed + "/" + result.total + ") passed";
                    textarea_output.value = JSON.stringify(result);
                } else {
                    a_message.value = 'done';
                    textarea_output.value = result.output[0];
                }
                
                // Must reset the memory so that network can properly rebuild the memory expression.
                global_network_memory_reset();
                textarea_expression.value = network.to_expression();
                network.destroy();
            } catch(e) {
                logger(e.toString());
            }
        })().then(() => { is_running = false }).catch(() => { is_running = false });
    } catch(e) {
        logger(e.stack);
    }
}
function reload() { window.location.reload(true) }
</script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
<script src="../src/js/detail/helpers.js"></script>
<script src="../src/js/detail/layers.js"></script>
<script src="../src/js/detail/collectors.js"></script>
<script src="../src/js/detail/neural.js"></script>
<script src="../src/js/detail/expression.js"></script>
<script src="../src/js/nerve.js"></script>

<div>
    <textarea rows="2" cols="100" id="header" placeholder="header"></textarea>
</div>
<div>
    <textarea rows="10" cols="100" id="code" placeholder="code"></textarea>
</div>
<div>
    <textarea rows="2" cols="100" id="footer" placeholder="footer"></textarea>
</div>
<div>
    <button onclick="execute()">RUN</button>
</div>
<div>
    <a id="message"></a>
</div>
<div>
    <textarea rows="10" cols="100" id="output" placeholder="output"></textarea>
</div>
<div>
    <textarea rows="10" cols="100" id="expression"></textarea>
</div>
<div>
    <textarea rows="20" cols="100" id="debug"></textarea>
</div>
<div>
    <button onclick="reload()">RELOAD</button>
</div>

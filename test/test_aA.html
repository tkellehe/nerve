<script>
logger_output = "";
function logger(s) {
    let textarea_debug = document.getElementById("debug");
    logger_output += s + "\n";
    textarea_debug.value = logger_output;
}
is_running = false;
async function execute() {
    let a_message = document.getElementById("message");
    try {
        if(is_running) return;
        let textarea_header = document.getElementById("header");
        let textarea_code = document.getElementById("code");
        let textarea_footer = document.getElementById("footer");
        let textarea_output = document.getElementById("output");
        let textarea_expression = document.getElementById("expression");
        a_message.innerHTML = "running...";
        is_running = true;
        let code = textarea_header.value + textarea_code.value + textarea_footer.value;
        let result = await nerve.execute_verbose(code);
        if(result.is_learning) {
            a_message.innerHTML = "(" + result.num_passed + "/" + result.total + " successes) " + (result.num_passed === result.total ? "passed" : "failed");
            textarea_output.value = JSON.stringify(result.output);
        } else {
            a_message.innerHTML = 'done';
            if(result.output.length === 1) {
                textarea_output.value = result.output[0];
            } else if(result.output.length) {
                if(result.is_checking) {
                    a_message.innerHTML =  "(" + result.num_passed + "/" + result.total + " successes) " + (result.num_passed === result.total ? "passed" : "failed");
                }
                textarea_output.value = JSON.stringify(result.output);
            } else {
                textarea_output.value = '';
            }
        }
        textarea_expression.value = result.expression;
        
        is_running = false;
    } catch(e) {
        logger(e.stack);
        is_running = false;
        a_message.innerHTML = 'exception';
    }
}
function reload() { window.location.reload(true) }
</script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
<script src="../src/js/detail/helpers.js"></script>
<script src="../src/js/detail/layers.js"></script>
<script src="../src/js/detail/collectors.js"></script>
<script src="../src/js/detail/neural.js"></script>
<script src="../src/js/detail/expression.js"></script>
<script src="../src/js/nerve.js"></script>

<div>
    <textarea rows="2" cols="100" id="header" placeholder="header"></textarea>
</div>
<div>
    <textarea rows="10" cols="100" id="code" placeholder="code">expression.network(expression.mapping("Aa"),expression.layers(),expression.mapping("Aa"))</textarea>
</div>
<div>
    <textarea rows="2" cols="100" id="footer" placeholder="footer">.input('a', 'A').expected('A', 'a').loss.meanSquaredError().optimizer.sgd(0.001).learn()</textarea>
</div>
<div>
    <button onclick="execute()">RUN</button><a id="message"></a>
</div>
<div>
    <textarea rows="10" cols="100" id="output" placeholder="output"></textarea>
</div>
<div>
    <textarea rows="10" cols="100" id="expression"></textarea>
</div>
<div>
    <textarea rows="20" cols="100" id="debug"></textarea>
</div>
<div>
    <button onclick="reload()">RELOAD</button>
</div>

<script>
logger_output = "";
function logger(s) {
    let textarea_debug = document.getElementById("debug");
    logger_output += s + "\n";
    textarea_debug.value = logger_output;
}
function execute() {
    try {
    if(learning !== undefined) throw Error("Still Learning...");
    let textarea_code = document.getElementById("code");
    let textarea_input = document.getElementById("input");
    let textarea_output = document.getElementById("output");
    let textarea_expression = document.getElementById("expression");
    let network = eval("(function() { return " + textarea_code.value + "})()").finalize();
    textarea_output.value = network.predict(textarea_input.value);
    textarea_expression.value = network.to_expression();
    } catch(e) {
    let textarea_debug = document.getElementById("debug");
    textarea_debug.value = e.toString();
    }
}
learning = undefined;
function learn() {
    try {
        if(learning !== undefined) throw Error("Still Learning...");
        let textarea_code = document.getElementById("code");
        let textarea_output = document.getElementById("output");
        let textarea_expression = document.getElementById("expression");
        let textarea_batches = document.getElementById("batches");
        let textarea_batch_input = document.getElementById("batch_input");
        let textarea_batch_expected = document.getElementById("batch_expected");
        let textarea_batch_actual = document.getElementById("batch_actual");
        let a_success = document.getElementById("success");

        let network = eval("(function() { return " + textarea_code.value + "})()").finalize();
        
        textarea_batch_actual.value = "";
        a_success.innerHTML = "learning";
        let num_batches = parseInt(textarea_batches.value);
        if(Number.isNaN(num_batches)) { num_batches = 1; textarea_batches.value = "1"; }
        let inputs = eval("(function() { return " + textarea_batch_input.value + "})()");
        let expecteds = eval("(function() { return " + textarea_batch_expected.value + "})()");
        
        learning = setTimeout(function(){
            network.batch(inputs, expecteds, num_batches);
            textarea_expression.value = network.to_expression();
            let actuals = [];
            let success = "passed";
            for(let i = 0, l = inputs.length; i < l; ++i) {
                actuals.push(network.predict(inputs[i]));
                if(actuals[i] !== expecteds[i]) success = "failed";
            }
            a_success.innerHTML = success;
            textarea_batch_actual.value = actuals.toString();
            learning = undefined;
        });
    } catch(e) {
        let textarea_debug = document.getElementById("debug");
        textarea_debug.value = e.toString();
    }
}
function reload() { window.location.reload(true) }
</script>

<div>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
    <script src="../src/js/detail/helpers.js"></script>
    <script src="../src/js/detail/layers.js"></script>
    <script src="../src/js/detail/collectors.js"></script>
    <script src="../src/js/detail/neural.js"></script>
    <script src="../src/js/detail/expression.js"></script>
    <script src="../src/js/nerve.js"></script>

    <!-- <textarea rows="10" cols="30" id="code">expression.network(expression.mapping("Aa"),expression.layers(expression.layer()),expression.mapping("Aa"))</textarea> -->
    <textarea rows="10" cols="30" id="code">expression.network(expression.mapping("Aa"),expression.layers(expression.layer(2,2,expression.number("%00%C0%7F%3F"),expression.number("%00%00%80%3F"),expression.number("%00%00%80%3F"),expression.number("%00%C0%7F%3F"),expression.number("%04%20%83%BA"),expression.number("%04%20%83%BA"))),expression.mapping("Aa"),0.001)</textarea>
    <button onclick="execute()">RUN</button>
    <textarea rows="1" cols="10" id="output"></textarea>
    <textarea rows="1" cols="10" id="input" placeholder="input"></textarea>
    <textarea rows="10" cols="30" id="expression"></textarea>
</div>
<div>
    <button onclick="learn()">LEARN</button>
    <textarea rows="1" cols="5" id="batches">1</textarea>
    <div>
        <textarea rows="1" cols="30" id="batch_input" placeholder="input list"></textarea>
        <textarea rows="1" cols="30" id="batch_expected" placeholder="expected output list"></textarea>
    </div>
    <div>
        <textarea rows="1" cols="30" id="batch_actual" placeholder="current predictions"></textarea>
        <a id="success"></a>
    </div>
</div>
<div>
    <textarea rows="20" cols="100" id="debug"></textarea>
</div>
<div>
    <button onclick="reload()">RELOAD</button>
</div>
